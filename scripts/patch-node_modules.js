/* Patch @hellocoop node_modules references to symlink to modules here
 * looks in directories beside this one for any repos that have 
 */
const fs = require('fs')
const workspaces = require('../package.json').workspaces
const regex = /@hellocoop\/(.*)/;

const patch = ( packages ) => {
    for (const package in packages) {
        if (!package.startsWith('@hellocoop'))
            continue;
        const module = regex.exec(package)[1]
        if (workspaces.includes(module)) {
            const oldReference = packages[package]
            packages[package] = `file:../packages/${module}`
            console.log(`${oldReference} changed to ${packages[package]}`)
        }
        else
            console.error(`There is no workspace for ${module}`)
    }
}


const args = process.argv;

if (args.length < 3)
    return console.error(`
Usage: npm run patch -- <project>
where <project> is the sibliing directory to be patched
eg
    npm run patch -- hello-nextjs-starter
`)

// const project = `../../${args[2]}/package.json`
const project = `../${args[2]}/package.json`

try {
    const oldJSON = fs.readFileSync(project)
    const package = JSON.parse(oldJSON)
    patch(package.dependencies)
    patch(package.devDependencies)
    const newJSON = JSON.stringify(package,null,4)
    fs.writeFileSync(project,newJSON)
    console.log('\nyou will need to run `npm install` again')
} catch(err) {
    console.error(`Could not open "${project}"`)
    console.error(err)
}